{% extends 'layouts/base.html' %}
{% load bootstrap4 static i18n custom_tags %}

{% block content %}
    <div class="row">
        <div class="col-8">
            <div class="card h-100">
                <div class="card-header border-0">
                    <div class="card-title">
                        <div class="pt-1 fs20 lh25 text-bold-family">
                            {{ doc.internal_code }}
                        </div>
                    </div>
                </div>
                <div class="card-body text-left">
                    <div class="row mr-2">
                        <div class="col-12">
                            <label>{% translate 'Summary' %}</label>
                            <p id="issue_description">
                                {% if "b'" in doc.description %}
                                    ****
                                    <i class="fas fa-eye pull-right link show-data" id="show-data-description"
                                        title='{% translate "Show sensitive data" %}'></i>
                                {% else %}
                                    {{ doc.description }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="overlay-wrapper">
                        <div id="attachments"></div>
                        <div class="overlay" id="load-attachments-spin">
                            <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                        </div>
                    </div>
                    {% if doc.category.id != 2 %}
                    <hr />
                    <div class="card-header border-0">
                        <div class="card-title">
                            <div class="pt-1 fs20 lh25 text-bold-family">
                                {% translate 'Decisions' %}
                            </div>
                        </div>
                    </div>
                    <div class="overlay-wrapper" 
                    {% if user.id == doc.assignee.id %}
                        style="border: 2px solid black; padding: 11px; border-style: dashed;" 
                    {% endif %}
                    >

                        <div id="attachments-reason"></div>

                        <div class="card mh-750">
                            
                            <div class="card-header">
                                {% if enable_add_comment and permission_to_edit and user.id == doc.assignee.id and not doc.escalate_flag %}
                                    <div class="row mb-3">
                                        <div class="col-1">
                                            {% with indexed_users|get:user.id as color_index %}
                                                <div class="circle-icon navbar-{{ colors|next_in_circular_list:color_index }}
                                                text-white text-bold-family">
                                                    <div class="center-32 pt-1">
                                                        {{ user.first_name.0|upper }}{{ user.last_name.0|upper }}
                                                    </div>
                                                </div>
                                            {% endwith %}
                                        </div>
                                        <div class="col-9">
                                            {% bootstrap_form reason_comment_form %}
                                        </div>
                                        <div class="col-2">
                                            <button class="btn btn-primary btn-sm fs12 rounded-xl" disabled id="add_comment_reason">
                                                {% translate "Save" %}
                                            </button>
                                            <br /><br />
                                            
                                            <a class="btn btn-primary btn-sm fs12 rounded-xl {% if not permission_to_edit %}
                                                disabled{% endif %}"
                                                id="add_attachment_reason">
                                                    <i class="fa fa-file-o"></i>
                                            </a>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            {% comment %} <div class="card-body overflow-y-auto">
                                <div class="overlay-wrapper">
                                    <div id="comments_reason">
                                        {% include 'grm/issue_comments.html' with comments=doc.comments colors=colors indexed_users=indexed_users %}
                                    </div>
                                    <div class="overlay" id="load-comments-spin-reason">
                                        <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                                    </div>
                                </div>
                            </div> {% endcomment %}
                        </div>



                        
                        <div class="overlay" id="load-attachments-spin-reason">
                            <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card h-100">
                <div class="card-body">

                    <div class="overlay-wrapper">
                        <div id="status_buttons"></div>
                        <div class="overlay" id="load-status-buttons-spin">
                            <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                        </div>
                    </div>

                    {% bootstrap_field form.assignee layout='horizontal' %}
                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Reporter' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {{ doc.reporter.name }}
                        </div>
                    </div>
                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Reported' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {{ doc.created_date|string_to_date|date:'j - F - Y' }}
                        </div>
                    </div>
                    {% if doc.citizen_type %}
                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Lodged by' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {% get_citizen_type_alt_display doc.citizen_type %}
                        </div>
                    </div>
                    {% endif %}
                    {% if doc.citizen %}
                        <div class="row mr-2 mb-2">
                            <div class="col-3">
                                <label class="label-align">
                                    {% translate 'Name' %}
                                </label>
                            </div>
                            <div class="col-9 text-regular-family">
                                {% if user|has_group:'Admin' %}
                                    <div id="citizen">
                                        *****
                                        <i class="fas fa-eye pull-right link show-data"
                                           title='{% translate "Show sensitive data" %}'></i>
                                    </div>
                                {% elif doc.assignee.id != user.id and doc.citizen_type == 1 %}
                                    {% translate 'Confidential' %}
                                {% else %}
                                    <div id="citizen">
                                        *****
                                        <i class="fas fa-eye pull-right link show-data"
                                           title='{% translate "Show sensitive data" %}'></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if doc.citizen_age_group %}
                        <div class="row mr-2 mb-2">
                            <div class="col-3">
                                <label class="label-align">
                                    {% translate 'Age' %}
                                </label>
                            </div>
                            <div class="col-9 text-regular-family">
                                {% if user|has_group:'Admin' %}
                                    {{ doc.citizen_age_group.name }}
                                {% elif doc.assignee.id != user.id and doc.citizen_type == 1 %}
                                    {% translate 'Confidential' %}
                                {% else %}
                                    {{ doc.citizen_age_group.name }}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Location' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {% if user|has_group:'Admin' %}
                                {% get_administrative_region_name doc.administrative_region.administrative_id %}
                            {% elif doc.assignee.id != user.id and doc.citizen_type == 1 %}
                                {% translate 'Confidential' %}
                            {% else %}
                                {% get_administrative_region_name doc.administrative_region.administrative_id %}
                            {% endif %}
                        </div>
                    </div>

                    {% if doc.location_info and doc.location_info.location_description %}
                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Location description' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {% if user|has_group:'Admin' %}
                                {{ doc.location_info.location_description }}
                            {% elif doc.assignee.id != user.id and doc.citizen_type == 1 %}
                                {% translate 'Confidential' %}
                            {% else %}
                                {{ doc.location_info.location_description }}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Category' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {{ doc.category.name }}
                        </div>
                    </div>

                    {% if doc.structure_in_charge %}
                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Structure in charge' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {% if user|has_group:'Admin' %}
                                {% if doc.structure_in_charge.name %}{{ doc.structure_in_charge.name }} {% else %} - {% endif %}
                                {% if doc.structure_in_charge.phone %} | {{ doc.structure_in_charge.phone }} {% endif %}
                                {% if doc.structure_in_charge.email %} | {{ doc.structure_in_charge.email }} {% endif %}
                            {% elif doc.assignee.id != user.id and doc.citizen_type == 1 %}
                                {% translate 'Confidential' %}
                            {% else %}
                                {% if doc.structure_in_charge.name %}{{ doc.structure_in_charge.name }} {% else %} - {% endif %}
                                {% if doc.structure_in_charge.phone %} | {{ doc.structure_in_charge.phone }} {% endif %}
                                {% if doc.structure_in_charge.email %} | {{ doc.structure_in_charge.email }} {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if doc.original_description %}
                    <hr />
                    <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Original description' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            <div id="original_description">
                                *****
                                <i class="fas fa-eye pull-right link show-data" id="original-description"
                                    title='{% translate "Show sensitive data" %}'></i>
                            </div>
                        </div>
                    </div>
                    <hr />
                    {% endif %}
                    
                    {% comment %} <div class="row mr-2 mb-2">
                        <div class="col-3">
                            <label class="label-align">
                                {% translate 'Type' %}
                            </label>
                        </div>
                        <div class="col-9 text-regular-family">
                            {{ doc.issue_type.name }}
                        </div>
                    </div> {% endcomment %}
                    {% if doc.escalation_reasons %}
                        <hr />
                        {% translate "The issue was escalated" %}
                        <hr />
                        {% for escalation_reason in doc.escalation_reasons %}
                            <div class="row">
                                <div class="col-6">
                                    {% with indexed_users|get:escalation_reason.id as color_index %}
                                        <div class="circle-icon float-left mr-2 navbar-{{ colors|next_in_circular_list:color_index }}">
                                            <div class="center-32 pt-1 text-white text-bold-family">
                                                {% get_initials escalation_reason.name %}
                                            </div>
                                        </div>
                                    {% endwith %}
                                    <div class="text-bold-family">
                                        {{ escalation_reason.name }}
                                    </div>
                                    <div class="text-regular-family">
                                        {{ escalation_reason.due_at|string_to_date|date:'j-F-Y' }}
                                    </div>
                                </div>
                                <div class="col-6 text-right lh15 mt-3 text-regular-family">
                                    {% get_hour escalation_reason.due_at %}
                                </div>
                            </div>
                            <div class="row border-bottom mt-2 mb-3">
                                <div class="col-10 mb-2 text-regular-family mb-3">
                                    {{ escalation_reason.comment|safe }}
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-8">
            <div class="card mh-750">
                <div class="card-header border-0">
                    <div class="card-title">
                        <div class="pt-1 fs20 lh25 text-bold-family">
                            {% comment %} {% translate 'Steps Taken' %} {% endcomment %}
                            {% translate 'Comments' %}
                        </div>
                    </div>
                </div>
                <div class="card-header">
                    {% if enable_add_comment and permission_to_edit %}
                        <div class="row mb-3">
                            <div class="col-1">
                                {% with indexed_users|get:user.id as color_index %}
                                    <div class="circle-icon navbar-{{ colors|next_in_circular_list:color_index }}
                                    text-white text-bold-family">
                                        <div class="center-32 pt-1">
                                            {{ user.first_name.0|upper }}{{ user.last_name.0|upper }}
                                        </div>
                                    </div>
                                {% endwith %}
                            </div>
                            <div class="col-9">
                                {% bootstrap_form comment_form %}
                            </div>
                            <div class="col-2">
                                <button class="btn btn-primary btn-sm fs12 rounded-xl" disabled id="add_comment">
                                    {% translate "Save" %}
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body overflow-y-auto">
                    <div class="overlay-wrapper">
                        <div id="comments">
                            {% include 'grm/issue_comments.html' with comments=doc.comments colors=colors indexed_users=indexed_users %}
                        </div>
                        <div class="overlay" id="load-comments-spin">
                            <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block modals %}
    <div id="fileFormModal" class="modal" role="dialog" aria-hidden="true" data-backdrop="static"></div>
    <div id="statusChangeModalForm" class="modal" role="dialog" aria-hidden="true" data-backdrop="static"></div>

    <div class="modal fade modal-confirmation" id="checkPasswordModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title mx-auto">
                        <img src="{% static 'images/password-required.png' %}" height="254">
                    </h5>
                    <button type="button" class="border-0 bg-transparent" data-dismiss="modal"
                            aria-label="Close">
                        <div class="circle-icon bg-primary">
                            <div class="center-27">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-primary text-center fs17 lh19 text-bold mb-4"
                         style="padding: 0 45px 0 45px;">
                        {% translate "Please enter your password to show sensitive data" %}
                    </div>
                    {% bootstrap_form password_confirm_form %}
                </div>
                <div class="modal-footer border-0">
                    <button id="check-password" type="submit" class="btn btn-lg btn-primary text-right">
                        {% translate "Check password" %}
                    </button>
                </div>
            </div>
        </div>
    </div>




    {% comment %} <div id="fileFormModalReason" class="modal" role="dialog" aria-hidden="true" data-backdrop="static"></div>
    <div id="statusChangeModalFormReason" class="modal" role="dialog" aria-hidden="true" data-backdrop="static"></div>

    <div class="modal fade modal-confirmation" id="checkPasswordModalReason">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title mx-auto">
                        <img src="{% static 'images/password-required.png' %}" height="254">
                    </h5>
                    <button type="button" class="border-0 bg-transparent" data-dismiss="modal"
                            aria-label="Close">
                        <div class="circle-icon bg-primary">
                            <div class="center-27">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-primary text-center fs17 lh19 text-bold mb-4"
                         style="padding: 0 45px 0 45px;">
                        {% translate "Please enter your password to show sensitive data" %}
                    </div>
                    {% bootstrap_form password_confirm_form %}
                </div>
                <div class="modal-footer border-0">
                    <button id="check-password-reason" type="submit" class="btn btn-lg btn-primary text-right">
                        {% translate "Check password" %}
                    </button>
                </div>
            </div>
        </div>
    </div> {% endcomment %}

{% endblock modals %}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'js/csrfSafeMethodAjax.js' %}"></script>
    <script src="{% static 'js/formAjaxSubmit.js' %}"></script>
    <script type="text/javascript">
        let load_attachments_spin = $('#load-attachments-spin');
        let load_attachments_spin_reason = $('#load-attachments-spin-reason');
        let load_status_buttons_spin = $('#load-status-buttons-spin');
        let status_change_modal = $('#statusChangeModalForm');
        let assignee = $('#id_assignee');

        {% if not user|has_group:'Admin' and not user|has_group:'Assignee' %}
            //not permission_to_edit
            assignee.prop("disabled", true);
        {% elif doc.category.id == 2 %}
            assignee.prop("disabled", true);
        {% endif %}

        assignee.on('change', function () {
            $.ajax({
                type: "POST",
                url: "{% url 'dashboard:grm:edit_issue' doc.auto_increment_id %}",
                data: {
                    "assignee": assignee.val()
                },
                success: function (response) {
                    showPopupMessage(response.msg);
                },
                error: function (data, status, error) {
                            if(error == "Forbidden"){
                                alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                            }else{
                                alert(error_server_message + "Error " + data.status);
                            }
                        }
            });
        });

        class OpenStatusFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadStatusButtons();
            }
        }
        let open_reason_form_ajax = new OpenStatusFormAjaxSubmit();

        class ResearchResultFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadStatusButtons();
            }
        }
        let research_result_form_ajax = new ResearchResultFormAjaxSubmit();

        class UnresolveFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadStatusButtons();
            }
        }
        let unresolved_reason_form_ajax = new UnresolveFormAjaxSubmit();

        class EscalateFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadStatusButtons();
            }
        }
        let escalate_reason_form_ajax = new EscalateFormAjaxSubmit();

        class PublishFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadStatusButtons();
            }
        }
        let issue_publish_form_ajax = new PublishFormAjaxSubmit();

        class UnpublishFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadStatusButtons();
            }
        }
        let issue_unpublish_form_ajax = new UnpublishFormAjaxSubmit();

        class RejectReasonFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadStatusButtons();
            }
        }
        let reject_reason_form_ajax = new RejectReasonFormAjaxSubmit();


        function loadStatusButtons() {
            load_status_buttons_spin.show();
            $('#status_buttons').load("{% url 'dashboard:grm:issue_status_buttons' doc.auto_increment_id %}", function (
                response, status, xhr) {
                if (status === "error") {
                    alert(error_server_message + "Error " + response.status);
                }
                load_status_buttons_spin.hide();
                let accept_issue = $("#accept_issue");
                let record_resolution = $("#record_resolution");
                let reject_issue = $("#reject_issue");
                let set_unresolved = $("#set_unresolved");
                let escalate_issue = $("#escalate_issue");
                let publish_issue = $("#publish_issue");
                let unpublish_issue = $("#unpublish_issue");

                {% if not permission_to_edit %}
                    $('.btn-status').prop("disabled", true);
                {% endif %}

                {% comment %} accept_issue.on('click', function () {
                    $.ajax({
                        type: "POST",
                        url: "{% url 'dashboard:grm:submit_issue_open_status' doc.auto_increment_id %}",
                        success: function (response) {
                            showPopupMessage(response.msg);
                            loadStatusButtons();
                        },
                        error: function (data, status, error) {
                            if(error == "Forbidden"){
                                alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                            }else{
                                alert(error_server_message + "Error " + data.status);
                            }
                        }
                    });
                }); {% endcomment %}
                
                accept_issue.on('click', function () {
                    let url = "{% url 'dashboard:grm:submit_issue_open_status' doc.auto_increment_id %}";
                    open_reason_form_ajax.load_form('#open_reason_form', status_change_modal, url);
                });



                record_resolution.on('click', function () {
                    let url = "{% url 'dashboard:grm:submit_issue_research_result' doc.auto_increment_id %}";
                    research_result_form_ajax.load_form('#research_result_form', status_change_modal, url);
                });

                set_unresolved.on('click', function () {
                    let url = "{% url 'dashboard:grm:submit_issue_set_unresolved' doc.auto_increment_id %}";
                    unresolved_reason_form_ajax.load_form('#unresolved_reason_form', status_change_modal, url);
                });

                escalate_issue.on('click', function () {
                    let url = "{% url 'dashboard:grm:submit_issue_escalate' doc.auto_increment_id %}";
                    escalate_reason_form_ajax.load_form('#escalate_reason_form', status_change_modal, url);
                });

                publish_issue.on('click', function () {
                    let url = "{% url 'dashboard:grm:submit_issue_publish' doc.auto_increment_id %}";
                    issue_publish_form_ajax.load_form('#issue_publish_form', status_change_modal, url);
                });

                unpublish_issue.on('click', function () {
                    let url = "{% url 'dashboard:grm:submit_issue_unpublish' doc.auto_increment_id %}";
                    issue_unpublish_form_ajax.load_form('#issue_unpublish_form', status_change_modal, url);
                });

                reject_issue.on('click', function () {
                    let url = "{% url 'dashboard:grm:submit_issue_reject_reason' doc.auto_increment_id %}";
                    reject_reason_form_ajax.load_form('#reject_reason_form', status_change_modal, url);
                });

            });
        }

        //Attachments

        class FileFormAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                loadAttachments();
            }
        }

        let file_form_ajax = new FileFormAjaxSubmit();
        let file_form_modal = $('#fileFormModal');

        function loadAttachments() {
            load_attachments_spin.show();
            $('#attachments').load(
                "{% url 'dashboard:grm:issue_attachments' doc.auto_increment_id %}?column=1&attr=attachments", function (
                    response, status, xhr) {
                    if (status === "error") {
                        alert(error_server_message + "Error " + response.status);
                    }
                    load_attachments_spin.hide();
                    $('#add_attachment').click(function () {
                        let url = "{% url 'dashboard:grm:upload_issue_attachment' doc.auto_increment_id %}";
                        file_form_ajax.load_form('#form', file_form_modal, url, false, true);
                    });
                });
        }

        $(document).ready(function () {
            loadAttachments();
            loadStatusButtons();
            $('b[role="presentation"]').hide();
            $('.select2-selection__arrow').append(
                '<i class="fas fa-chevron-circle-down text-primary" style="margin-top:12px;"></i>');
        });

        {% comment %} $(document).on('click', '.delete-attachment', function () {
            $.ajax({
                url: $(this).data('url'),
                type: 'POST'
            })
                .fail(function (data, status, error) {
                            if(error == "Forbidden"){
                                alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                            }else{
                                alert(error_server_message + "Error " + data.status);
                            }
                        })
                .done(function (data) {
                    loadAttachments();
                    showPopupMessage(data.msg);
                })
        }); {% endcomment %}


        //Reason - Attachments
        class FileFormReasonAjaxSubmit extends FormAjaxSubmit {
            submitted_form() {
                reasonLoadAttachments();
            }
        }

        let file_form_ajax_reason = new FileFormReasonAjaxSubmit();
        {% comment %} let file_form_modal_reason = $('#fileFormModalReason'); {% endcomment %}
        let file_form_modal_reason = $('#fileFormModal');

        function reasonLoadAttachments() {
            load_attachments_spin_reason.show();
            $('#attachments-reason').load(
                "{% url 'dashboard:grm:issue_attachments' doc.auto_increment_id %}?column=2&attr=reasons", function (
                    response, status, xhr) {
                    if (status === "error") {
                        alert(error_server_message + "Error " + response.status);
                    }
                    load_attachments_spin_reason.hide();
                    $('#add_attachment_reason').click(function () {
                        let url = "{% url 'dashboard:grm:upload_issue_attachment' doc.auto_increment_id %}?reason=1";
                        file_form_ajax_reason.load_form('#form', file_form_modal_reason, url, false, true);
                    });
                });
        }

        $(document).ready(function () {
            reasonLoadAttachments();
            loadStatusButtons();
            $('b[role="presentation"]').hide();
            $('.select2-selection__arrow').append(
                '<i class="fas fa-chevron-circle-down text-primary" style="margin-top:12px;"></i>');
        });

        $(document).on('click', '.delete-attachment', function () {
            $.ajax({
                url: $(this).data('url'),
                type: 'POST'
            })
                .fail(function (data, status, error) {
                            if(error == "Forbidden"){
                                alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                            }else{
                                alert(error_server_message + "Error " + data.status);
                            }
                        })
                .done(function (data) {
                    loadAttachments();
                    reasonLoadAttachments();
                    showPopupMessage(data.msg);
                })
        });

        //End Attachemnts


        //Comments
        let add_comment = $('#add_comment');
        let load_comments_spin = $('#load-comments-spin');
        load_comments_spin.hide();
        let comment = $('#id_comment');

        function loadComments() {
            load_comments_spin.show();
            $('#comments').load("{% url 'dashboard:grm:issue_comments' doc.auto_increment_id %}", function (
                response, status, xhr) {
                if (status === "error") {
                    alert(error_server_message + "Error " + response.status);
                }
                load_comments_spin.hide();
            });
        }

        add_comment.click(function () {
            $.ajax({
                type: "POST",
                url: "{% url 'dashboard:grm:add_comment_to_issue' doc.auto_increment_id %}",
                data: {
                    "comment": comment.val(),
                    issue_password_comment: $('#id_issue_password_comment').val(),
                },
                success: function (response) {
                    showPopupMessage(response.msg);
                    loadComments();
                    comment.val('');
                    add_comment.prop('disabled', true);
                },
                error: function (data, status, error) {
                            if(error == "Forbidden"){
                                alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                            }else{
                                alert(error_server_message + "Error " + data.status);
                            }
                        }
            });
        });

        comment.on('keyup', function () {
            if ($(this).val().trim()) {
                add_comment.prop('disabled', false);
            } else {
                add_comment.prop('disabled', true);
            }
        });

        //Reason comments
        let add_comment_reason = $('#add_comment_reason');
        let load_comments_spin_reason = $('#load-comments-spin-reason');
        load_comments_spin_reason.hide();
        let comment_reason = $('#id_reason');

        {% comment %} function reasonLoadComments() {
            load_comments_spin_reason.show();
            $('#comments_reason').load("{% url 'dashboard:grm:issue_comments' doc.auto_increment_id %}", function (
                response, status, xhr) {
                if (status === "error") {
                    alert(error_server_message + "Error " + response.status);
                }
                load_comments_spin_reason.hide();
            });
        } {% endcomment %}

        add_comment_reason.click(function () {
            $.ajax({
                type: "POST",
                url: "{% url 'dashboard:grm:add_comment_to_issue' doc.auto_increment_id %}?reason=1",
                data: {
                    "comment": comment_reason.val(),
                    issue_password_reason: $('#id_issue_password_reason').val(),
                },
                success: function (response) {
                    showPopupMessage(response.msg);
                    reasonLoadAttachments();
                    comment_reason.val('');
                    add_comment_reason.prop('disabled', true);
                },
                error: function (data, status, error) {
                            if(error == "Forbidden"){
                                alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                            }else{
                                alert(error_server_message + "Error " + data.status);
                            }
                        }
            });
        });

        comment_reason.on('keyup', function () {
            if ($(this).val().trim()) {
                add_comment_reason.prop('disabled', false);
            } else {
                add_comment_reason.prop('disabled', true);
            }
        });
        //End Comments




        var type_checking = "citizen"; //issue_description
        var attachment_url_view = null;
        function show_dta(){
            $(document).on('click', '.show-data', function () {
                if(this.id == "show-data-description"){
                    type_checking = "issue_description";
                }else if(this.id.includes("show_data_attachment_")){
                    type_checking = "issue_data_attachment";
                    attachment_url_view = $(this).data('url');
                }else if(this.id == "original-description"){
                    type_checking = "original_description";
                }
                $('#checkPasswordModal').modal('show');
            });
            {% comment %} $(".show-data").click(function () {
                if(this.id == "show-data-description"){
                    type_checking = "issue_description";
                }else if(this.id.includes("show-data-attachment-")){
                    type_checking = "issue_data_attachment";
                }
                $('#checkPasswordModal').modal('show');
            }); {% endcomment %}
        }
        show_dta();
        
        function hide_data(){
            $(".hide-data").click(function () {
                this.id = this.id.replace('hide', 'show');
                $(('#'+type_checking)).html(`
                    ****
                    <i class="fas fa-eye pull-right link show-data" id="`+this.id+`"
                        title='{% translate "Show sensitive data" %}'></i>
                `);
            });
        show_dta();
        }
        

        $("#check-password").click(function () {
            if(type_checking == "issue_data_attachment"){
                console.log(attachment_url_view);
                if(attachment_url_view){
                    {% comment %} $.ajax({
                        url: attachment_url_view,
                        type: 'POST',
                        data: {
                             "password": $("#id_password").val()
                        }
                    })
                    .fail(function (data, status, error) {
                                if(error == "Forbidden"){
                                    alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                                }else{
                                    alert(error_server_message + "Error " + data.status);
                                }
                            })
                    .done(function (data) {
                        showPopupMessage(data.msg);
                        $('#checkPasswordModal').modal('hide');
                    }); {% endcomment %}
                    
                    window.open(`${attachment_url_view}?_token={{csrf_token}}&_ttoken={{csrf_token}}&password=${$("#id_password").val()}&token={{csrf_token}}`,"_blank");
                }
                
            }else if(type_checking == "issue_description"){
                $.ajax({
                    type: "POST",
                    url: "{% url 'dashboard:grm:get_issue_description' doc|get:'auto_increment_id' %}",
                    data: {
                        "password": $("#id_password").val(),
                        "id": "{{ doc|get:'_id' }}",
                    },
                    success: function (response) {
                        showPopupMessage(response.msg);
                        let data = response.data;
                        if (data && data.description) {
                            $("#issue_description").html(
                                data.description
                                +
                                `
                                <i class="fas fa-eye pull-right link show-data" id="show-data-description"
                                    title='{% translate "Show sensitive data" %}'></i>
                                `
                                {% comment %} +`
                                <i class="fas fa-eye-slash pull-right link hide-data" id="hide-data-description"
                                        title='{% translate "Hide sensitive data" %}'></i>
                                ` {% endcomment %}
                            );
                            {% comment %} hide_data(); {% endcomment %}
                        }
                        $('#checkPasswordModal').modal('hide');
                    },
                    error: function (data, status, error) {
                                if(error == "Forbidden"){
                                    alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                                }else{
                                    alert(error_server_message + "Error " + data.status);
                                }
                            }
                });

                //Decrypt Comments
                $.ajax({
                    type: "GET",
                    url: "{% url 'dashboard:grm:issue_comments_decrypt' doc|get:'auto_increment_id' %}",
                    data: {
                        "password": $("#id_password").val(),
                        "id": "{{ doc|get:'_id' }}",
                    },
                    success: function (response) {
                        $("#comments").html(response);
                    },
                    error: function (data, status, error) {
                            }
                });
                //End Decrypt Comments

                //Decrypt Reasons
                $.ajax({
                    type: "GET",
                    url: "{% url 'dashboard:grm:issue_reasons_decrypt' doc|get:'auto_increment_id' %}",
                    data: {
                        "password": $("#id_password").val(),
                        "id": "{{ doc|get:'_id' }}",
                    },
                    success: function (response) {
                        $("#attachments-reason").html(response);
                    },
                    error: function (data, status, error) {
                            }
                });
                //End Decrypt Reasons

            }else if(type_checking == "original_description"){
                $.ajax({
                    type: "POST",
                    url: "{% url 'dashboard:grm:get_original_description_issue_data' doc|get:'auto_increment_id' %}",
                    data: {
                        "password": $("#id_password").val(),
                        "id": "{{ doc|get:'_id' }}",
                    },
                    success: function (response) {
                        showPopupMessage(response.msg);
                        let data = response.data;
                        if (data && data.original_description) {
                            $("#original_description").html(data.original_description);
                        }
                        $('#checkPasswordModal').modal('hide')
                    },
                    error: function (data, status, error) {
                                if(error == "Forbidden"){
                                    alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                                }else{
                                    alert(error_server_message + "Error " + data.status);
                                }
                            }
                });
            }else{
                $.ajax({
                    type: "POST",
                    url: "{% url 'dashboard:grm:get_sensitive_issue_data' doc|get:'auto_increment_id' %}",
                    data: {
                        "password": $("#id_password").val(),
                        "id": "{{ doc|get:'_id' }}",
                    },
                    success: function (response) {
                        showPopupMessage(response.msg);
                        let data = response.data;
                        if (data && data.citizen) {
                            $("#citizen").html(
                                data.citizen 
                                {% comment %} + `
                            <i class="fas fa-eye-slash pull-right link hide-data" id="hide-data-description"
                                        title='{% translate "Hide sensitive data" %}'></i>    
                            ` {% endcomment %}
                            );
                            {% comment %} hide_data(); {% endcomment %}
                        }
                        $('#checkPasswordModal').modal('hide')
                    },
                    error: function (data, status, error) {
                                if(error == "Forbidden"){
                                    alert(`{% translate "You don't have permission to request this request." %}` + " Error " + data.status);
                                }else{
                                    alert(error_server_message + "Error " + data.status);
                                }
                            }
                });
            }
            
        });


        


        $(document).ready(function(){
            let issue_password_comment = $('#id_issue_password_comment');
            let issue_password_comment_parent = issue_password_comment.parent();
            let issue_password_reason = $('#id_issue_password_reason');
            let issue_password_reason_parent = issue_password_reason.parent();


            var password_fields = [issue_password_comment, issue_password_reason];
            var password_fields_parent = [issue_password_comment_parent, issue_password_reason_parent];
            var password_fields_more = [...password_fields, $('#id_password')]; 
            
            password_fields_more.forEach(function(elt){
                elt.keyup(function () {
                    password_fields_more.forEach(function(item){
                        item.val(elt.val());
                    });
                });
            });

            password_fields.forEach(function(elt){
                {% if doc.category.id == 4 or doc.category.id == 7 %}
                    elt.attr('required', true);
                {% else %}
                    elt.attr('required', false);
                {% endif %}
            });
            password_fields_parent.forEach(function(elt){
                {% if doc.category.id == 4 or doc.category.id == 7 %}
                    elt.show();
                {% else %}
                    elt.hide();
                {% endif %}
            }); 

        });

        

    </script>
{% endblock javascript %}
